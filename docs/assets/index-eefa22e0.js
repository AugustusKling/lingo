(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))l(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const u of n.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&l(u)}).observe(document,{childList:!0,subtree:!0});function o(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerpolicy&&(n.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?n.credentials="include":s.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function l(s){if(s.ep)return;s.ep=!0;const n=o(s);fetch(s.href,n)}})();const F=document.querySelector("#courseTemplate");F.removeAttribute("id");F.remove();const K=document.querySelector("#courseDetailsTemplate");K.removeAttribute("id");K.remove();const A=document.querySelector("#lessonTemplate");A.removeAttribute("id");A.remove();const R=document.querySelector("#lessonOngoingTemplate");R.removeAttribute("id");R.remove();const B=await(await fetch("dist-data/courses/index.json")).json(),E=document.querySelector(".courseList"),H=document.querySelector(".courseDetails"),b=document.querySelector(".lessonOngoing");let O,T;function J(){if(T)return T;{const e=JSON.parse(localStorage.knowledge||"{}");return T=e,e}}function te(e){T=e,localStorage.knowledge=JSON.stringify(e)}V();function W(e,t){const o=J()[e]?.[t];if(!o)return"unseen";const l=new Date().getTime();return o.lastAnswersCorrect.length>2&&o.lastAnswersCorrect.every(s=>s)&&l<o.hiddenUntil?"learned":o.lastAnswersCorrect.find((s,n)=>!s&&o.lastAnswersCorrect.length-n<=3)===!1?"wrong":"somewhat"}function G(e,t){const o=B[t],l=Object.keys(J()[t]||{});M(e,t,l,o.exercises)}function M(e,t,o,l){const s=o.map(c=>W(t,c)),n=s.filter(c=>c==="wrong").length,u=s.filter(c=>c==="somewhat").length,p=s.filter(c=>c==="learned").length,w=l-n-u-p;e.querySelector(".wrong").style.flex=n,e.querySelector(".somewhat").style.flex=u,e.querySelector(".learned").style.flex=p,e.querySelector(".unseen").style.flex=w}function V(){E.innerHTML="";const e=Object.keys(B).sort();for(const t of e){const o=B[t],l=F.cloneNode(!0);l.querySelector(".title").append(t),l.querySelector(".hint").append(`${o.lessons} lessons, ${o.exercises} exercises`),l.addEventListener("click",()=>C(t)),G(l.querySelector(".progress"),t),E.append(l)}E.style.display="block",H.style.display="none",b.style.display="none",location.hash.length>1&&(location.hash="",history.replaceState(null,"",location.pathname))}let U;async function C(e){const t=O===e&&U?U:await(await fetch("dist-data/courses/"+encodeURI(e+".json"))).json();U=t,H.innerHTML="";const o=K.cloneNode(!0);o.querySelector(".title").append(`${t.from} to ${t.to}`),G(o.querySelector(".progress"),e),o.querySelector(".buttonBack").addEventListener("click",()=>V());const l=o.querySelector(".lessons");for(const c of[...t.lessons].sort((i,r)=>i.order-r.order)){const i=A.cloneNode(!0);i.querySelector(".title").append(c.title[t.to]||c.title[t.from]),i.querySelector(".hint").append(`${c.exercises.length} exercises`),M(i.querySelector(".progress"),e,c.exercises,c.exercises.length),i.addEventListener("click",()=>ne(t,c)),l.append(i)}const s=new Set;t.exercerciseList.flatMap(c=>c.categories).forEach(c=>s.add(c));const n=Array.from(s).sort(),u=o.querySelector(".categories");for(const c of n){const i=A.cloneNode(!0);i.querySelector(".title").append(c);const r=t.exercerciseList.filter(m=>m.categories.includes(c));i.querySelector(".hint").append(`${r.length} exercises`),M(i.querySelector(".progress"),e,r.map(m=>m.conceptName),r.length),i.addEventListener("click",()=>z(t,r)),u.append(i)}const p={Training:t.exercerciseList.filter(c=>["wrong","somewhat"].includes(W(e,c.conceptName))),New:t.exercerciseList.filter(c=>W(e,c.conceptName)==="unseen"),Uncategorized:t.exercerciseList.filter(c=>c.categories.length===0)},w=o.querySelector(".dynamicCategories");for(const[c,i]of Object.entries(p)){const r=A.cloneNode(!0);r.querySelector(".title").append(c),r.querySelector(".hint").append(`${i.length} exercises`),M(r.querySelector(".progress"),e,i.map(m=>m.conceptName),i.length),i.length>0&&r.addEventListener("click",()=>z(t,i)),w.append(r)}H.append(o),E.style.display="none",H.style.display="block",b.style.display="none",location.hash="#course",O=e}function ne(e,t){const o=e.exercerciseList.filter(l=>t.exercises.includes(l.conceptName));Q(e,o)}function z(e,t){Q(e,t)}function k(e){return e[Math.floor(Math.random()*e.length)]}function se(e,t,o,l){const s=t.filter(n=>n!==e&&!l.includes(n));if(Math.random()>.5){const n=s.filter(u=>u.categories.some(p=>e.categories.includes(p)));if(n.length>0)return k(n)}if(Math.random()>.5){const n=s.filter(u=>{const p=u.translations[o][0].text.length/e.translations[o][0].text.length;return p>.5&&p<1.5});if(n.length>0)return k(n)}return k(s)}function oe(e,t,o,l){const s=[];for(;s.length<t;)s.push(se(e,o,l,s));return s}function re(e,t){const o=/[.多?,?!;-]/g;return e.replace(o,"").toLowerCase()===t.replace(o,"").toLowerCase()}function Q(e,t){const o=Math.min(10,t.length),l=[...t],s=[];for(;s.length<o;){const h=Math.floor(Math.random()*l.length);s.push(...l.splice(h,1))}b.innerHTML="";const n=R.cloneNode(!0),u=n.querySelector("progress");u.max=o,u.value=0;const p=n.querySelector(".correctAnswerHint"),w=n.querySelector(".correctAnswer"),c=n.querySelector(".pickAnswer"),i=n.querySelector(".typeAnswer"),r=n.querySelector("input"),m=n.querySelector(".wordSuggestions"),L=n.querySelector(".questionHint");n.querySelector(".buttonClear").addEventListener("click",()=>r.value="");let a;function D(){a=s.splice(0,1)[0],u.value=o-s.length,n.querySelector(".question").innerHTML="";const h=k(a.translations[e.from]);n.querySelector(".question").append(h.text);const S=a.descriptions?.[e.from];S?(L.innerText=S,L.style.display="block"):L.style.display="none",n.querySelector(".buttonDefinition").addEventListener("click",()=>Y(a,h.text,e.from)),p.style.display="none",r.value="",Math.random()>.5&&h.text.includes(" ")?(c.style.display="none",i.style.display="block"):(c.style.display="block",i.style.display="none"),n.querySelectorAll(".pickAnswer p.answer").forEach(d=>d.remove());const y=oe(a,2,e.exercerciseList,e.to),v=k(a.translations[e.to]),g=[v,...y.map(d=>k(d.translations[e.to]))];g.sort(()=>Math.random()-.5);const N=speechSynthesis.getVoices().filter(d=>d.lang.startsWith(e.to)),_=N.length>0&&Math.random()<.5;for(const d of g){const f=document.createElement("p");if(f.className="answer",_){const x=document.createElement("button");x.append("Speak"),x.addEventListener("click",()=>{c.querySelectorAll(".selected").forEach(I=>I.className="answer"),f.className="answer selected",r.value=d.text,Z(d.text,N)}),f.append(x)}else f.append(d.text),f.addEventListener("click",()=>{r.value=d.text,$()});c.append(f);const j=document.createElement("button");j.append("Info");const ee=y.find(x=>Object.values(x.translations[e.to]).some(I=>I===d))||a;j.addEventListener("click",x=>{x.stopPropagation(),Y(ee,d.text,e.to)}),f.append(j)}m.innerHTML="";const P=Array.from(new Set([...g.flatMap(d=>d.text.split(/\s+|[.多?,?!;]/)).filter(d=>d!==""),...g.flatMap(d=>Array.from(new Set(d.text.replace(/[^.多?,?!;]/g,""))))])).sort(()=>Math.random()-.5);for(const d of P){const f=document.createElement("p");f.className="wordSuggestion",f.append(d),f.addEventListener("click",()=>{r.value===""?r.value=d:/^[.多?,?!;]$/.test(d)?r.value=r.value+d:r.value=r.value+" "+d}),m.append(f)}w.innerHTML="",w.append(v.text)}function $(){if(p.style.display==="none"){const h=a.translations[e.to].some(v=>re(v.text,r.value)),S=J(),y=S?.[q]?.[a.conceptName]||{lastAnswersCorrect:[],hiddenUntil:0};if(S[q]||(S[q]={}),S[q][a.conceptName]=y,y.lastAnswersCorrect.length>9&&y.lastAnswersCorrect.splice(0,1),y.lastAnswersCorrect.push(h),!h)y.hiddenUntil=0;else{const v=y.lastAnswersCorrect.reduce((g,N)=>N?g+1:g-1,0);y.lastAnswersCorrect.length<10?y.hiddenUntil=new Date().getTime()+v*6e5:y.hiddenUntil=new Date().getTime()+v*864e5}te(S),h?s.length>0?D():C(q):(c.style.display="none",i.style.display="none",p.querySelector(".wrongAnswer").innerText=r.value,p.style.display="block")}else s.length>0?D():C(q)}const q=`${e.from} to ${e.to}`;n.querySelector(".buttonBack").addEventListener("click",()=>C(q)),n.querySelector(".buttonConfirm").addEventListener("click",()=>$()),r.addEventListener("keypress",h=>{h.key==="Enter"&&$()}),D(),b.append(n),E.style.display="none",H.style.display="none",b.style.display="block",location.hash="#lesson"}document.querySelector(".definitionOverlay .buttonBack").addEventListener("click",()=>X());function X(){document.querySelector(".definitionOverlay").style.display="none",location.hash="#lesson"}const ce={"https://creativecommons.org/licenses/by-sa/3.0/":"CC BY-SA 3.0"};function Y(e,t,o){const l=document.querySelector(".definitionOverlay");l.querySelector(".title").innerText=t;const s=l.querySelector(".hint"),n=e.descriptions?.[o];n?(s.innerText=n,s.style.display="block"):s.style.display="none";const u=l.querySelector(".translations");u.innerHTML="";for(const[p,w]of Object.entries(e.translations)){const c=document.createElement("h2");c.append(`Translations: ${p}`),u.append(c);const i=speechSynthesis.getVoices().filter(r=>r.lang.startsWith(p));for(const r of w){const m=document.createElement("div");m.className="translation",u.append(m);const L=document.createElement("h3");if(L.append(r.text),m.append(L),i.length>0){const a=document.createElement("button");a.append("Speak"),a.addEventListener("click",()=>Z(r.text,i)),m.append(a)}if(r.source){const a=document.createElement("a");a.href=r.source,r.author?a.append(`${r.author}, ${a.hostname}`):a.append(a.hostname),m.append(a)}if(r.licence){const a=document.createElement("a");a.href=r.licence,a.append(`Licence: ${ce[r.licence]||r.licence}`),m.append(a)}}}document.querySelector(".definitionOverlay").style.display="flex",location.hash="#definition"}function Z(e,t){const o=new SpeechSynthesisUtterance(e);o.voice=k(t),o.lang=o.voice.lang,speechSynthesis.speak(o)}addEventListener("hashchange",()=>{location.hash==="#lesson"&&X(),location.hash==="#course"&&O&&C(O),(location.hash===""||location.hash==="#")&&V()});
